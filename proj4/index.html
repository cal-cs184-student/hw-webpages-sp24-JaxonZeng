<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <style>
    body {
      padding: 100px;
      width: 1000px;
      margin: auto;
      text-align: left;
      font-weight: 300;
      font-family: 'Open Sans', sans-serif;
      color: #121212;
    }

    h1,
    h2,
    h3,
    h4 {
      font-family: 'Source Sans Pro', sans-serif;
    }
  </style>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
  </script>



  <title>CS 180 Project 4: Image Warping and Mosaicing</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Source+Sans+Pro" rel="stylesheet">
</head>


<body>


  <h1 align="middle">CS 180 Project 4: Image Warping and Mosaicing</h1>
  <h2 align="middle">Jaxon Zeng</h2>

  <br><br>

  <div>




    <h2 align="middle">Part A</h2>
    <h3 align="middle">Shoot the Pictures</h3>
    <p>To prepare for this project, I have shot several sets of pictures for later steps. In each set, I setup several
      correspondence points for each pair of pictures.</p>
    The first set is the beautiful San Francisco skyline during a clear night. I took the set with a camera on a long
    focal length lens.

    <h4 align="middle">San Francisco Skyline</h4>
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/1-1-1.png" align="middle" width="300px" />
            <figcaption align="middle">SF 1</figcaption>
          </td>
          <td>
            <img src="images/1-1-2.png" align="middle" width="300px" />
            <figcaption align="middle">SF 2</figcaption>
          </td>
          <td>
            <img src="images/1-1-3.png" align="middle" width="300px" />
            <figcaption align="middle">SF 3</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <h5>Correspondence 1-2</h5>
        <tr>
          <td>
            <img src="images/1-1-4.png" align="middle" width="500px" />
          </td>
          <td>
            <img src="images/1-1-5.png" align="middle" width="500px" />

          </td>
        </tr>
      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <h5>Correspondence 2-3</h5>
        <tr>

          <td>
            <img src="images/1-1-6.png" align="middle" width="500px" />
          </td>
          <td>
            <img src="images/1-1-7.png" align="middle" width="500px" />

          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>
    <h4 align="middle">Village under Snow Mountain</h4>
    <p>The second set is a village under the beautiful mountain. I took this set with a wide angle lens.</p>
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/1-2-1.png" align="middle" width="300px" />
            <figcaption align="middle">MT 1</figcaption>
          </td>
          <td>
            <img src="images/1-2-2.png" align="middle" width="300px" />
            <figcaption align="middle">MT 2</figcaption>
          </td>
          <td>
            <img src="images/1-2-3.png" align="middle" width="300px" />
            <figcaption align="middle">MT 3</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <h5>Correspondence 1-2</h5>
        <tr>
          <td>
            <img src="images/1-2-4.png" align="middle" width="500px" />
          </td>
          <td>
            <img src="images/1-2-5.png" align="middle" width="500px" />

          </td>
        </tr>
      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <h5>Correspondence 2-3</h5>
        <tr>

          <td>
            <img src="images/1-2-6.png" align="middle" width="500px" />
          </td>
          <td>
            <img src="images/1-2-7.png" align="middle" width="500px" />

          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>
    <h4 align="middle">My Living Room</h4>
    <p>I took the third set randomly in my living room with my phone.</p>
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/1-3-1.png" align="middle" width="300px" />
            <figcaption align="middle">RM 1</figcaption>
          </td>
          <td>
            <img src="images/1-3-2.png" align="middle" width="300px" />
            <figcaption align="middle">RM 2</figcaption>
          </td>
          <td>
            <img src="images/1-3-3.png" align="middle" width="300px" />
            <figcaption align="middle">RM 3</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <h5>Correspondence 1-2</h5>
        <tr>
          <td>
            <img src="images/1-3-4.png" align="middle" width="500px" />
          </td>
          <td>
            <img src="images/1-3-5.png" align="middle" width="500px" />

          </td>
        </tr>
      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <h5>Correspondence 2-3</h5>
        <tr>

          <td>
            <img src="images/1-3-6.png" align="middle" width="500px" />
          </td>
          <td>
            <img src="images/1-3-7.png" align="middle" width="500px" />

          </td>
        </tr>
      </table>
    </div>

    <h3 align="middle">Recover Homographies</h3>
    <p>To recover homographies, I need to find a matrix to perform projective mapping between correspondence points. The
      matrix has 8 degrees of freedom and the lower right corner is set to 1 since all my images are taken with the same
      focal length within the same set.</p>
    <p>
      $$
      H = \begin{bmatrix}
      h_1 & h_2 & h_3 \\
      h_4 & h_5 & h_6 \\
      h_7 & h_8 & 1
      \end{bmatrix}
      $$

      For each correspondence points $p'$ and $p$, I will have $p' = Hp$.
      $$
      \begin{bmatrix}
      x' \\
      y' \\
      1
      \end{bmatrix}
      =
      \begin{bmatrix}
      h_1 & h_2 & h_3 \\
      h_4 & h_5 & h_6 \\
      h_7 & h_8 & 1
      \end{bmatrix}
      \begin{bmatrix}
      x \\
      y \\
      1
      \end{bmatrix}
      $$

      Expanding the matrix I have:
      $$
      \begin{aligned}
      x' &= h_1 x + h_2 y + h_3 \\
      y' &= h_4 x + h_5 y + h_6 \\
      w' &= h_7 x + h_8 y + 1
      \end{aligned}
      $$

      To set the scaling factor to 1, I normalized the result by the third row:
      $$
      x' = \frac{h_1 x + h_2 y + h_3}{h_7 x + h_8 y + 1}
      $$
      $$
      y' = \frac{h_4 x + h_5 y + h_6}{h_7 x + h_8 y + 1}
      $$
      Simplify the result we have:
      $$
      h_1 x + h_2 y + h_3 - x' (h_7 x + h_8 y + 1) = 0
      $$
      $$
      h_4 x + h_5 y + h_6 - y' (h_7 x + h_8 y + 1) = 0
      $$
      Write this result back to matrix form:
      $$
      \begin{align}

      \begin{bmatrix}
      -x & -y & -1 & 0 & 0 & 0 & x' x & x' y & x' \\
      0 & 0 & 0 & -x & -y & -1 & y' x & y' y & y'
      \end{bmatrix}&\begin{bmatrix}
      h_1 \\
      h_2 \\
      h_3 \\
      h_4 \\
      h_5 \\
      h_6 \\
      h_7 \\
      h_8 \\
      1
      \end{bmatrix} &= &0 \\

      A&h &= &0
      \end{align}
      $$

      To eliminate error, I set more correspondence points than the equation needed. When solving the matrix, I try to
      get the minimum error solution. I use Singular Value Decomposition for $H$.
      <br>
      In SVD, we decomposite $A$ into three components.
      $$
      A = U \Sigma V^T
      $$
      The solution for $H$ is the last column of $V^T$. I reshape the last column to a $3\times3$ matrix. And normalized
      the matrix based on the bottom right corner to retrive $H$.

    </p>

    <h3 align="middle">Warp the Images</h3>
    After I get the recovery matrix from correspondence points, I can simply use forward warpping to transform one image
    into another by multiplying the coordinates with $H$. To map the original image into the new transformed image, I
    use <code>scipy.interpolate.griddata</code> to interpolate the color of the new coordinates. I also calculate the
    the size of output image by the four corners of the new image.
    <br>
    To test the result of the warping function, I rectify some images to make parts of the images into a shape of
    square.

    <div align="middle">
      <table style="width=100%">
        <h5>TV into square</h5>
        <tr>
          <td>
            <img src="images/3-1-1.png" align="middle" width="500px" />
          </td>
          <td>
            <img src="images/3-1-2.png" align="middle" width="500px" />

          </td>
        </tr>
      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <h5>Road Sign into square</h5>
        <tr>
          <td>
            <img src="images/3-2-1.png" align="middle" width="500px" />
          </td>
          <td>
            <img src="images/3-2-2.png" align="middle" width="500px" />
          </td>
        </tr>
      </table>
    </div>

    <h3 align="middle">Blend Images into a Mosaic</h3>
    Here comes the most interesting part of the project. I can finally blend the images into a single panorama. I use
    the warping function to warp the images into the result shape. Then I compute their bounding box to decide their
    position in the final image. Then I align each image based on their position.
    At first I use a hard blending that directly put the three images into the final image.
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/1-1-1.png" align="middle" width="300px" />
            <figcaption align="middle">SF 1</figcaption>
          </td>
          <td>
            <img src="images/1-1-2.png" align="middle" width="300px" />
            <figcaption align="middle">SF 2</figcaption>
          </td>
          <td>
            <img src="images/1-1-3.png" align="middle" width="300px" />
            <figcaption align="middle">SF 3</figcaption>
          </td>
        </tr>
        <tr>
          <td>
            <img src="images/4-1-1.png" align="middle" width="300px" />
            <figcaption align="middle">SF 1</figcaption>
          </td>
          <td>
            <img src="images/4-1-2.png" align="middle" width="300px" />
            <figcaption align="middle">SF 2</figcaption>
          </td>
          <td>
            <img src="images/4-1-3.png" align="middle" width="300px" />
            <figcaption align="middle">SF 3</figcaption>
          </td>
        </tr>

      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/4-1-4.png" align="middle" width="800px" />
            <figcaption align="middle">SF Pano</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>

    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/1-2-1.png" align="middle" width="300px" />
            <figcaption align="middle">MT 1</figcaption>
          </td>
          <td>
            <img src="images/1-2-2.png" align="middle" width="300px" />
            <figcaption align="middle">MT 2</figcaption>
          </td>
          <td>
            <img src="images/1-2-3.png" align="middle" width="300px" />
            <figcaption align="middle">MT 3</figcaption>
          </td>
        <tr>
          <td>
            <img src="images/4-2-1.png" align="middle" width="300px" />
            <figcaption align="middle">MT 1</figcaption>
          </td>
          <td>
            <img src="images/4-2-2.png" align="middle" width="300px" />
            <figcaption align="middle">MT 2</figcaption>
          </td>
          <td>
            <img src="images/4-2-3.png" align="middle" width="300px" />
            <figcaption align="middle">MT 3</figcaption>
          </td>
        </tr>

      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/4-2-4.png" align="middle" width="800px" />
            <figcaption align="middle">MT Pano</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>



    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/1-3-1.png" align="middle" width="300px" />
            <figcaption align="middle">RM 1</figcaption>
          </td>
          <td>
            <img src="images/1-3-2.png" align="middle" width="300px" />
            <figcaption align="middle">RM 2</figcaption>
          </td>
          <td>
            <img src="images/1-3-3.png" align="middle" width="300px" />
            <figcaption align="middle">RM 3</figcaption>
          </td>
        <tr>
          <td>
            <img src="images/4-3-1.png" align="middle" width="300px" />
            <figcaption align="middle">RM 1</figcaption>
          </td>
          <td>
            <img src="images/4-3-2.png" align="middle" width="300px" />
            <figcaption align="middle">RM 2</figcaption>
          </td>
          <td>
            <img src="images/4-3-3.png" align="middle" width="300px" />
            <figcaption align="middle">RM 3</figcaption>
          </td>
        </tr>

      </table>
    </div>
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/4-3-4.png" align="middle" width="800px" />
            <figcaption align="middle">RM Pano</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>

    The direct blending works fine for the first set of images. However, it's obvious that the panorama of the second
    and third set did not blend smoothly. To create a smooth blending between images, I use the Laplacian multilayer
    blending method from project 2. I use a gaussian filter to create a mask that smoothly merge the edge of two images
    together.
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/4-1-5.png" align="middle" width="800px" />
            <figcaption align="middle">SF Pano Smooth</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/4-2-5.png" align="middle" width="800px" />
            <figcaption align="middle">MT Pano Smooth</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="images/4-3-5.png" align="middle" width="800px" />
            <figcaption align="middle">RM Pano Smooth</figcaption>
          </td>
        </tr>
      </table>
    </div>

    <h2 align="middle">Part B</h2>
    In this part, instead of manually defined correspondence points, I will implement the method to auto align images
    and create the final mosaics. I will follow the paper <a
      href=https://inst.eecs.berkeley.edu/~cs180/fa24/hw/proj4/Papers/MOPS.pdf>“Multi-Image Matching using Multi-Scale
      Oriented Patches” by Brown et al</a> to establish correspondence in a set of images. Then used the 4-point RANSAC
    method to compute homography. At last, I will blend the image using the same method as part A.
    <h3 align="middle">Detecting Corners</h3>
    For the first step of corner detection, I used the Harris Corner Detection algorithm. I used the sample code
    <code>get_harris_corners</code>, where the Harris response is calculated by
    <code>skimage.feature.corner_harris</code> and then pick local maxima as corners by
    <code>skimage.feature.peak_local_max</code>.
    <br>
    As the algorithm is superlinear to number of corners in the images, I need to reduce the number of corners in order
    to speed up the algorithm. I followed the section 3 of the paper to implement Adaptive Non-Maximal Suppression. To
    perform ANMS, I calculated the pairwise distance using <code>dist2</code> from sample code. Then for each corner, I
    calculated the suppression radius by the minimum distance for it to meet another strong corner (strong means a high
    harris response value). Then I will sort the radii of corners and return the given number of points with the highest
    radii values. By this suppression algorithm, the remaining points are strong and evenly-distributed.

    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="imagesb/1-1-1.png" align="middle" width="500px" />
            <figcaption align="middle">RM1 Detected Corners</figcaption>
          </td>
          <td>
            <img src="imagesb/1-1-2.png" align="middle" width="500px" />
            <figcaption align="middle">RM1 ANMS Detected Corners (300 points)</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>
    <h3 align="middle">Feature Descriptor</h3>
    In the next step, I extract the features of each corners so that they could be used in feature matching for the next
    step. I used a patch of 8$\times$8 patch of pixels as the feature. I first sample a 40$\times$40 window around the
    corner and then use gaussian filter to blur the window. Then I call <code>cv2.resize</code> to resize the window
    into a 8$\times$8 patch of windows. Lastly, I normalized the patch as the feature for the corner.

    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="imagesb/2-1-1.png" align="middle" width="300px" />
            <figcaption align="middle">Sample Feature Descriptor 1</figcaption>
          </td>
          <td>
            <img src="imagesb/2-1-2.png" align="middle" width="300px" />
            <figcaption align="middle">Sample Feature Descriptor 2</figcaption>
          </td>
          <td>
            <img src="imagesb/2-1-3.png" align="middle" width="300px" />
            <figcaption align="middle">Sample Feature Descriptor 3</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>
    <h3 align="middle">Feature Matching</h3>
    Following the section 5 of the paper, I implement the feature matching to match the correspondence corners. I first
    calculate the distance between two set of descriptor by the norm of difference. By Lowe of thresholding, for a descriptor, if the distance of
    the closest descriptor is under a ratio of the distance of the second closest descriptor, then the two corners match.
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="imagesb/3-1-1.png" align="middle" width="1000px" />
            <figcaption align="middle">Matching corners between SF1 and SF2</figcaption>
          </td>
        </tr>
          
        <tr>
          <td>
            <img src="imagesb/3-1-2.png" align="middle" width="1000px" />
            <figcaption align="middle">Matching corners between SF2 and SF3</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>

    <h3 align="middle">RANSAC</h3>
    I used the standard 4-point RANSAC method to compute a homography estimate. In the RANSAC loop, the algorithm will calculate:<br>
    1. Select four feature pairs (at random)<br>
    2. Compute homography $H$ using the method from first part.<br>
    3. Compute the warpped points and determine inliers where $dist(p_i',Hp_i)<\varepsilon$.<br>
    4. Keep the largest set of inlier<br>
    After the loop finishes, recompute H estimate on all of the inliers.
    <div align="middle">
      <table style="width=100%">
        <tr>
          <td>
            <img src="imagesb/4-1-1.png" align="middle" width="800px" />
            <figcaption align="middle">Inliers for $Hp_i$(green), $p_i'$(red) on SF2</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>

    <h3 align="middle">Auto Mosaic</h3>
    Integrating all the methods, I can perform auto mosaics by simply passing in images.
    <br>
    <br>
    <div align="middle">
      SF
      <table style="width=100%">
        <tr>
          <td>
            <img src="imagesb/5-1-1.png" align="middle" width="1000px" />
            <figcaption align="middle">SF Autostitching</figcaption>
          </td>
        </tr>
          
        <tr>
          <td>
            <img src="images/4-1-5.png" align="middle" width="1000px" />
            <figcaption align="middle">SF Manual Stitching</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>
    <div align="middle">
      MT
      <table style="width=100%">
        <tr>
          <td>
            <img src="imagesb/5-1-2.png" align="middle" width="1000px" />
            <figcaption align="middle">MT Autostitching</figcaption>
          </td>
        </tr>
          
        <tr>
          <td>
            <img src="images/4-2-5.png" align="middle" width="1000px" />
            <figcaption align="middle">MT Manual Stitching</figcaption>
          </td>
        </tr>
      </table>
    </div>
    <br>
    <br>
    <div align="middle">
      RM
      <table style="width=100%">
        <tr>
          <td>
            <img src="imagesb/5-1-3.png" align="middle" width="1000px" />
            <figcaption align="middle">RM Autostitching</figcaption>
          </td>
        </tr>
          
        <tr>
          <td>
            <img src="images/4-3-5.png" align="middle" width="1000px" />
            <figcaption align="middle">RM Manual Stitching</figcaption>
          </td>
        </tr>
      </table>
    </div>


</body>

</html>